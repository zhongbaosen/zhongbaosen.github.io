---
title: 服务器部署git代码托管
date: 2018-3-15 17:08:17
tags: [git, centos]
---


## 具体步骤

### 安装git

<strong>首先安装git，一般而言，现在的服务器已经内置了git安装包，我们只需要执行简单的安装命令即可安装。比如：
</strong>

```bash
yum install git
```

### 创建git用户及权限

我们当然不允许直接使用root来进行通信交互了，所以，我们创建一个git用户来作为今后提交代码的用户。

```bash
adduser git
```

执行这条命令之后，你发现在/home目录下多了一个git目录，按理来说，现在，你的系统中多了这个git用户，并且家目录在/home/git。但是，我们并不希望这个用户通过ssh连接到服务器上面去，所以，我们要禁止这个用户使用ssh连接上去进行操作。我们通过编辑一个权限文件来处理：

```
vi /etc/passwd
```

找到类似于
```
git:x:1001:1001:,,,:/home/git:/bin/bash
```

这样的行，你看到那个末尾的/bin/bash，就是允许ssh连接操作的权限，我们把它改为/user/bin/git-shell，结果如下：

```
git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell
```

这样处理好，git就不能ssh连上去了（实际上是可以的，只不过会闪退）。

我们还得给git分配一个密码，执行：

```
passwd git 123456 #(你的密码)
```
这个密码用在你后面提交代码的时候使用。

### 公钥的配置

这个是git里面比较特殊的一步操作，通信的时候，客户端与服务器需要一个证书进行验证。操作方法很简单，首先在你自己的电脑上（centos）生成自己的一个公钥：

-- 注意这个是客户端操作
```bash
git config --global user.name "your name"  
  
git config --global user.email "xxxx@xxx.com"
```

```
cd ~

ssh-keygen -t rsa -C "xxxx@xxx.com"
```

这时你自己电脑上就有一个公钥了，但是在哪里呢？在.ssh目录下，.开头的文件夹都是隐藏的，但是可以cd进去。

```
cd .ssh

vi id_rsa.pub
```

这样就能看到你的公钥了，把所有的内容复制下来。接下来，我们去回服务器上面操作。

--注意这个是客户端操作

```
cd /home/git/

mkdir .ssh

cd .ssh

vi authorized_keys
```

复制你的id_rsa.pub内的公钥到authorized_keys内就完工了

接下来，我们用git命令初始化一个仓库：

```
git init --bare arepoforyourproject.git
```

初始化完成之后，这个空的仓库就OK了。

这里有一个细节，就是.git目录必须要有可读写权限，因为当我们在push的时候，是使用git用户推送到服务器上面去，会有一个写入的过程，如果不赋予可写权限，push就会失败。

### 试验克隆

回到你本地的电脑上，我们通过克隆来试试仓库是否可以使用：
```
git clone git@10.0.0.121:/var/git/arepoforyourproject.git
```
然后会提示你输入git的密码，输入进去，然后会再提示你克隆了一个空白的版本库。这说明服务器已经OK了。

### 上传本地代码到私有仓库

在服务器上创建了空白的版本库后,例如你是在window下进行上传,打开项目路径,右键打开git bash,输入指令

初始化git
```bash
git init
```

例如你要创建一个文件README

```bash
touch README
```

暂存README
```bash
git add README
```

提交代码并描述更新内容
```bash
git commit -m "更新个说明"
```

绑定项目的地址
```bash
git remote add origin git@xxx.xxx.xxx.xxx:/yourdir/arepoforyourproject.git
```

第一次更新到matser主分支上
```bash
git push -u origin master
```

### 非22端口的配置

当gitlab服务器ssh端口不是默认的22时，使用ssh连接gitlab会出现上面的错误

　解决方法：
　修改/etc/gitlab/gitlab.rd

　gitlab_rails['gitlab_shell_ssh_port'] = 9988    修改为sshd_config里的端口

sudo gitlab-ctl reconfigure     执行重新载入配置文件
登录查看gitlab的项目地址可以看到域名后加了个端口


### 多用户和权限管理

如果团队很小，把每个人的公钥收集起来放到服务器的/home/git/.ssh/authorized_keys文件里就是可行的。如果团队有几百号人，就没法这么玩了，这时，可以用Gitosis来管理公钥。






